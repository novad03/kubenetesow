language: python # (Ansible)

sudo: required

branches:
  except:
    - /^experimental\/.*$/
    - /^exp\/.*$/
    - /^development\/.*$/
    - /^dev\/.*$/
    - /^testing\/.*$/
    - /^test\/.*$/

before_install:
  # Add CI keys
  - >
    openssl aes-256-cbc
    -K $encrypted_d4d3f0a1e05a_key
    -iv $encrypted_d4d3f0a1e05a_iv
    -in test/ci-keys/kubenow-ci.enc
    -out test/ci-keys/kubenow-ci
    -d
  - >
    openssl aes-256-cbc
    -K $encrypted_d4d3f0a1e05a_key
    -iv $encrypted_d4d3f0a1e05a_iv
    -in kubenow-ci.pub.enc
    -out kubenow-ci.pub
    -d
  # Add the keypair to the agent
  - ssh-add test/ci-keys/kubenow-ci

install:
  # Install deps by HashiCorp
  - >
      curl
      https://releases.hashicorp.com/packer/0.11.0/packer_0.11.0_linux_amd64.zip
      > /tmp/packer.zip
  - >
      curl
      https://releases.hashicorp.com/terraform/0.7.8/terraform_0.7.8_linux_amd64.zip
      > /tmp/terraform.zip
  - sudo unzip /tmp/packer.zip -d /usr/bin
  - sudo unzip /tmp/terraform.zip -d /usr/bin
  - sudo chmod +x /usr/bin/packer
  - sudo chmod +x /usr/bin/terraform
  # Install Ansible
  - sudo pip install --upgrade pip
  - sudo pip install ansible==2.2.0.0
  # Source CityCloud RC file
  - source test/secrets-kubenow/host_cloud/CityCloud.sh

script:
  - ansible-playbook -e "host_cloud=openstack" test/cheese-deployment.yml
