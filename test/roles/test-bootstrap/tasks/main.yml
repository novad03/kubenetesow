- name: "wait for SSH"
  wait_for:
  args:
    port: 22
    host: "{{ansible_ssh_host}}"

- name: "test bootstrap"
  command: >
    sh -c
    'ansible master -a "kubectl get nodes" |
    grep "Ready" | wc -l'
  args:
    chdir: "{{playbook_dir}}/.."
  register: kubectl
  until: "{{kubectl.stdout|trim}} == {{node_count}}"
  # Try for 10 minutes
  retries: 20
  delay: 30
