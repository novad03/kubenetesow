#!/bin/bash

HOST_CLOUD="$2"

echo "Initializing $INIT_DIR deployment directory for cloud provider $HOST_CLOUD"

# Copy config, scripts and template files to init dir
cp /opt/KubeNow/templates/terraform.tfvars.$HOST_CLOUD-template terraform.tfvars
cp -r /opt/KubeNow/$HOST_CLOUD .
cp -r /opt/KubeNow/common .
cp -r /opt/KubeNow/bootstrap .
cp -r /opt/KubeNow/bootstrap .
cp -r /opt/KubeNow/bin .
cp -r /opt/KubeNow/playbooks .
cp /opt/KubeNow/ansible.cfg .

# Generate and write kubetoken
tokenID=$(openssl rand -hex 3)
tokenVal=$(openssl rand -hex 8)
token="$tokenID.$tokenVal"

sed -i "s/your-kubeadm-token/${token}/g" terraform.tfvars.*-template

# Generate SSH keys
ssh-keygen -t rsa -N '' -f ssh_key
