#!/bin/ash
# shellcheck shell=bash

#Usage
USAGE="Usage: kn apply <aws|gce|openstack>"

# Validate command
if [ "$#" -eq 0 ]; then
  >&2 echo "Error: no arguments supplied"
  echo "$USAGE"
  exit 1
fi
HOST_CLOUD="$1"
ALLOWED="aws gce openstack"
if [[ ! "$ALLOWED" =~ $HOST_CLOUD ]]; then
  >&2 echo "Error: unrecognized host cloud '$HOST_CLOUD'"
  echo "$USAGE"
  exit 1
fi

# Import image (AWS doesn't need it)
if [ "$HOST_CLOUD" = 'openstack' ] || [ "$HOST_CLOUD" = 'gce' ]; then
  ansible-playbook playbooks/import-"$HOST_CLOUD"-image.yml
fi

# Deploy
terraform get -update "$HOST_CLOUD"
terraform apply "$TERRAFORM_OPT" "$HOST_CLOUD"
ansible-playbook "$ANSIBLE_OPT" playbooks/install-core.yml
